<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Multilingual Translator</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        .controls {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            margin-left: auto;
            margin-right: auto;
            max-width: 95%;
            box-sizing: border-box;
            border-radius: 8px;
        }
        #translation-output {
            display: flex;
            flex-direction: column;
            font-size: 2.2em; /* Large text for easy viewing */
            font-weight: bold;
            color: #333;
            min-height: 100px;
            max-height: 70vh; /* 60% of viewport height */
            padding: 20px;
            border: 2px solid #0056b3;
            text-align: left;
            overflow-y: auto;
            margin: 0 auto;
            max-width: 95%;
            box-sizing: border-box;
            white-space: pre-wrap;
        }

        /* New styles for bold/gray logic */
        .translation-entry {
            color: #888; /* Gray for old text */
            margin-bottom: 15px;
        }

        /* Automatically styles the NEWEST item at the top */
        .translation-entry:first-child {
            color: #000; /* Bold black for new text */
            font-weight: bold;
        }

        .info { font-size: 0.9em; color: #666; margin-top: 15px; }
    </style>
</head>
<body>

    <h1>Real-Time Meeting Translator</h1>

    <div class="controls">
        <input type="text" id="ipAddress" placeholder="Server IP Address (auto-detected)" style="width: 200px; padding: 8px; margin-right: 10px;">
        <button onclick="connectWebSocket()" style="padding: 8px 16px;">Connect</button>
    </div>

    <div class="controls">
        <label for="language-select">Select Your Language:</label>
        <select id="language-select">
	    <option value="zh-CN">Chinese</option>
            <option value="en" selected>English</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
            <option value="ja">Japanese</option>
            <option value="sw">Kiswahili</option>
            </select>
    </div>

    <div id="translation-output">Connecting...</div>

    <div class="info">
        <p>Status: <span id="status">Initializing</span></p>
    </div>

    <script>
        const outputDiv = document.getElementById('translation-output');
        const statusSpan = document.getElementById('status');
        const languageSelect = document.getElementById('language-select');
	const ipAddressInput = document.getElementById('ipAddress');
        const defaultPort = "8765";
        let socket = null;
        let selectedLanguage = languageSelect.value; 

	// Auto-detect server IP from the page we loaded from
	function getServerIP() {
		// If we loaded this page from http://192.168.1.100:8080,
		// the WebSocket shoul connect to 192.168.1.100:8765
		return window.location.hostname;
	}

	// Auto-fill the IP address field
	window.addEventListener('load', () => {
		const detectedIP = getServerIP();
		ipAddressInput.value = detectedIP;
		ipAddressInput.placeholder = detectedIP || "Server IP";
		// Auto-connect on page load
		connectWebSocket();
	});

        // Update selected language when the dropdown changes
        languageSelect.addEventListener('change', (event) => {
            selectedLanguage = event.target.value;
            outputDiv.innerHTML = "Language set to " + event.target.options[event.target.selectedIndex].text + ". Waiting for next translation...";
        });

        function connectWebSocket() {
            if (socket) {
                socket.close();
            }

	    const ipAddress = ipAddressInput.value.trim() || getServerIP(); 
            if (!ipAddress) {
                alert("Unable to detect server IP. Please enter manually.");
                return;
	    }
            
            const wsUrl = `ws://${ipAddress}:${defaultPort}`;
            statusSpan.textContent = `Connecting to ${ipAddress}...`;
            outputDiv.innerHTML = "Attempting to connect...";
            
            try {
                socket = new WebSocket(wsUrl);
            } catch (error) {
                statusSpan.textContent = `Error connecting: ${error.message}`;
                return;
            }
            
            socket.onopen = function() {
                statusSpan.textContent = "Connected";
                outputDiv.innerHTML = "Connected. Select your language to begin receiving translations.";
            };

            socket.onmessage = function(event) {
                try {
                    // 1. The message is the first level JSON: {"text": "JSON_STRING"}
                    const data = JSON.parse(event.data).text;
                    
                    // 2. Check for the 'New Talk' signal (which will be a string)
                    if (data === "New Talk") {
                        // Using a dashed line to separate topics
                        outputDiv.insertAdjacentHTML('afterbegin', '<hr style="width:100%; border:1px dashed #ccc; margin: 20px 0;">');
                        outputDiv.scrollTop = 0;
                        return;
                    }

                    // 3. The actual payload is the second level JSON string: {"language_code": "es", "text": "..."}
                    const payload = JSON.parse(data);
                    
                    // 4. Filter the payload based on the user's selected language
                    if (payload.language_code === selectedLanguage) {
                        // 5. Check for initial/default messages to replace them
                        const isInitialMessage = (
                            outputDiv.innerHTML.includes("Connected. Select your language") || (
                                outputDiv.innerHTML.includes("Language set to") && 
                                outputDiv.innerHTML.includes("Waiting for next translation")) ||
                            outputDiv.innerHTML.includes("Attempting to connect...")
                        );

                        if (isInitialMessage) {
                            outputDiv.innerHTML = ""; // Clear status messages before inserting real text
                        } 
 
                        // Create the entry. The CSS handles the bolding/graying automatically.
                        const html = `<div class="translation-entry">${payload.text}</div>`;
 
                        // Prepend the new translation
                        outputDiv.insertAdjacentHTML('afterbegin', html);

                        // Since new text is at the top, we scroll to the top
                        outputDiv.scrollTop = 0;
                    } 

                } catch (e) {
                    console.error("Error processing message:", e, event.data);
                }
            };

            socket.onclose = function() {
                statusSpan.textContent = "Disconnected";
                outputDiv.innerHTML = "Connection lost. Please try connecting again.";
            };

            socket.onerror = function(error) {
                statusSpan.textContent = "Error";
                outputDiv.innerHTML = "Error connecting to server. Please check IP address and try again.";
            };
        }
    </script>
</body>
</html>
