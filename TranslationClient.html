<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Multilingual Translator</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        .controls { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; }
        #translation-output {
            font-size: 2.5em; /* Large text for easy viewing */
            font-weight: bold;
            color: #333;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #0056b3;
            text-align: left;
            white-space: pre-wrap;
        }
        .info { font-size: 0.9em; color: #666; margin-top: 15px; }
    </style>
</head>
<body>

    <h1>Real-Time Meeting Translator</h1>

    <div class="controls">
        <input type="text" id="ipAddress" placeholder="Server IP Address (auto-detected)" style="width: 200px; padding: 8px; margin-right: 10px;">
        <button onclick="connectWebSocket()" style="padding: 8px 16px;">Connect</button>
    </div>

    <div class="controls">
        <label for="language-select">Select Your Language:</label>
        <select id="language-select">
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
            <option value="sw">Kiswahili</option>
            <option value="ja">Japanese</option>
	    <option value="zh-CN">Chinese</option>
            </select>
    </div>

    <div id="translation-output">Connecting...</div>

    <div class="info">
        <p>Status: <span id="status">Initializing</span></p>
    </div>

    <script>
        const outputDiv = document.getElementById('translation-output');
        const statusSpan = document.getElementById('status');
        const languageSelect = document.getElementById('language-select');
	const ipAddressInput = document.getElementById('ipAddress');
        const defaultPort = "8765";
        let socket = null;
        let selectedLanguage = languageSelect.value; 

	// Auto-detect server IP from the page we loaded from
	function getServerIP() {
		// If we loaded this page from http://192.168.1.100:8080,
		// the WebSocket shoul connect to 192.168.1.100:8765
		return window.location.hostname;
	}

	// Auto-fill the IP address field
	window.addEventListener('load', () => {
		const detectedIP = getServerIP();
		ipAddressInput.value = detectedIP;
		ipAddressInput.placeholder = detectedIP || "Server IP";
		// Auto-connect on page load
		connectWebSocket();
	});

        // Update selected language when the dropdown changes
        languageSelect.addEventListener('change', (event) => {
            selectedLanguage = event.target.value;
            outputDiv.innerHTML = "Language set to " + event.target.options[event.target.selectedIndex].text + ". Waiting for next translation...";
        });

        function connectWebSocket() {
            if (socket) {
                socket.close();
            }

	    const ipAddress = ipAddressInput.value.trim() || getServerIP(); 
            if (!ipAddress) {
                alert("Unable to detect server IP. Please enter manually.");
                return;
	    }
            
            const wsUrl = `ws://${ipAddress}:${defaultPort}`;
            statusSpan.textContent = `Connecting to ${ipAddress}...`;
            outputDiv.innerHTML = "Attempting to connect...";
            
            try {
                socket = new WebSocket(wsUrl);
            } catch (error) {
                statusSpan.textContent = `Error connecting: ${error.message}`;
                return;
            }
            
            socket.onopen = function() {
                statusSpan.textContent = "Connected";
                outputDiv.innerHTML = "Connected. Select your language to begin receiving translations.";
            };

            socket.onmessage = function(event) {
                try {
                    // 1. The message is the first level JSON: {"text": "JSON_STRING"}
                    const data = JSON.parse(event.data).text;
                    
                    // 2. Check for the 'New Talk' signal (which will be a string)
                    if (data === "New Talk") {
                        outputDiv.innerHTML = "--- NEW SPEAKER / TOPIC ---\n" + outputDiv.innerHTML;
                        return;
                    }

                    // 3. The actual payload is the second level JSON string: {"language_code": "es", "text": "..."}
                    const payload = JSON.parse(data);
                    
                    // 4. Filter the payload based on the user's selected language
                    if (payload.language_code === selectedLanguage) {
                        // 5. CRITICAL LOGIC: Check for initial/default messages to replace them
                        const isInitialMessage = (
                            outputDiv.innerHTML.includes("Connected. Select your language") ||
                            (outputDiv.innerHTML.includes("Language set to") && outputDiv.innerHTML.includes("Waiting for next translation"))
                        );

                        if (isInitialMessage) {
                            outputDiv.innerHTML = payload.text; // Replace the initial message
                        } else {
                            // Prepend the new translation followed by a newline
                            outputDiv.innerHTML = outputDiv.innerHTML + "\n" + payload.text;
                        } 
                    } 

                } catch (e) {
                    console.error("Error processing message:", e, event.data);
                }
            };

            socket.onclose = function() {
                statusSpan.textContent = "Disconnected";
                outputDiv.innerHTML = "Connection lost. Please try connecting again.";
            };

            socket.onerror = function(error) {
                statusSpan.textContent = "Error";
                outputDiv.innerHTML = "Error connecting to server. Please check IP address and try again.";
            };
        }
    </script>
</body>
</html>
